name: Deploy to Kubernetes

on:
  push:
    branches: [ "main" ]
    paths:
      - helm/**

permissions:
  contents: read

jobs:
  deploy-to-kubernetes:
    name: 'Deploy to Kubernetes'
    runs-on: ubuntu-latest
    environment: dev

    defaults:
      run:
        shell: bash
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up kubectl
      uses: azure/setup-kubectl@v1
      with:
        version: 'latest'
        installKubectl: true

    - name: Configure kubectl
      run: |
        echo "$KUBE_CONFIG" > kubeconfig
        export KUBECONFIG=$(pwd)/kubeconfig
      env:
        KUBE_CONFIG: ${{ secrets.AKS_KUBE_CONFIG }}

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: 'v3.x'

    - name: Deploy to Kubernetes
      run: |
        helm upgrade --install apis-umbrella-release ./helm/apis-umbrella
